---
name: Build

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Create a GitHub Release"
        required: true
        type: boolean
        default: false
      talos_version:
        description: "Talos version"
        required: true
        type: choice
        options:
          - v1.7.6
          - v1.7.5
          - v1.7.4
          - v1.7.3
          - v1.7.2
          - v1.7.1
          - v1.7.0
      device:
        description: "Device"
        required: true
        type: choice
        options:
          - orangepi-5
      #########################
      # Packages
      #########################
      repo_packages:
        description: "Repository to build packages from"
        required: true
        type: string
        default: "https://github.com/mahdtech/pkgs"
      branch_packages:
        description: "Branch to build packages from"
        required: true
        type: string
        default: "main"
      #########################
      # Base
      #########################
      repo_base:
        description: "Repository to build base from"
        required: true
        type: string
        default: "https://github.com/siderolabs/talos"
      branch_base:
        description: "Branch to build base from"
        required: true
        type: string
        default: "main"
      #########################
      # Overlay
      #########################
      repo_overlay:
        description: "Repository to build overlay from"
        required: true
        type: string
        default: "https://github.com/mahdtech/sbc-rockchip"
      branch_overlay:
        description: "Branch to build overlay from"
        required: true
        type: string
        default: "main"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  pull-requests: read
  statuses: read

env:
  FORCE_COLOR: "1"

  REGISTRY: ghcr.io
  ORGANISATION: ${{ github.repository_owner }}
  PROJECT: ${{ github.event.repository.name }}

  BRANCH_NAME_CURRENT: ${{ github.head_ref || github.ref_name }}
  BRANCH_NAME_DEFAULT: ${{ github.event.repository.default_branch }}

defaults:
  run:
    shell: bash

jobs:
  ##################################################
  # Packages
  ##################################################

  packages:
    name: Packages

    timeout-minutes: 1440
    continue-on-error: false

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        os:
          - ubuntu-latest

    steps:
      - id: checkout_repository
        name: Checkout repository
        uses: actions/checkout@v4

      # Setup Docker Buildx.
      - id: docker_buildx
        name: Setup Docker Buildx
        uses: ./.github/actions/docker-buildx
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Setup Make.
      - id: make
        name: Setup and run Make
        uses: ./.github/actions/setup_make
        with:
          repository: ${{ inputs.repo_packages }}
          branch: ${{ inputs.branch_packages }}
          path: ${{ github.workspace }}/_make/packages

      # Make Packages
      - id: make_packages
        name: Make packages
        env:
          TALOS_VERSION: ${{ inputs.talos_version }}
          DEVICE: ${{ inputs.device }}
          REGISTRY: ${{ env.REGISTRY }}
          USERNAME: ${{ github.actor }}
          TAG: ${{ inputs.talos_version }}-${{ inputs.device }}
        run: |
          pushd ${{ github.workspace }}/_make/packages
          echo "##### Making kernel config #####"
          make \
            USERNAME=${{ github.actor }} \
            kernel-olddefconfig
          echo "##### Making packages (kernel)#####"
          make \
            USERNAME=${{ github.actor }} \
            REGISTRY=${{ env.REGISTRY }} \
            TAG=${{ inputs.talos_version }}-${{ inputs.device }} \
            PLATFORM=linux/amd64,linux/arm64 \
            PUSH=true \
            kernel
          echo "##### Making packages (all) #####"
          make \
            USERNAME=${{ github.actor }} \
            REGISTRY=${{ env.REGISTRY }} \
            TAG=${{ inputs.talos_version }}-${{ inputs.device }} \
            PLATFORM=linux/amd64,linux/arm64 \
            PUSH=true
          popd

  ##################################################
  # Base
  ##################################################

  base:
    name: Base

    needs: packages

    timeout-minutes: 1440
    continue-on-error: false

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        os:
          - ubuntu-latest

    steps:
      - id: checkout_repository
        name: Checkout repository
        uses: actions/checkout@v4

      # Setup Docker Buildx.
      - id: docker_buildx
        name: Setup Docker Buildx
        uses: ./.github/actions/docker-buildx
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Setup Make.
      - id: make
        name: Setup and run Make
        uses: ./.github/actions/setup_make
        with:
          repository: ${{ inputs.repo_base }}
          branch: ${{ inputs.branch_base }}
          path: ${{ github.workspace }}/_make/base

      # Make Base
      - id: make_base
        name: Make base
        env:
          TALOS_VERSION: ${{ inputs.talos_version }}
          DEVICE: ${{ inputs.device }}
          REGISTRY: ${{ env.REGISTRY }}
          USERNAME: ${{ github.actor }}
          TAG: ${{ inputs.talos_version }}-${{ inputs.device }}
        run: |
          pushd ${{ github.workspace }}/_make/base
          echo "##### Making installer #####"
          make \
            PUSH=true \
            installer
          echo "##### Making talosctl-image #####"
          make \
            PUSH=true \
            talosctl-image
          echo "##### Making kernel initramfs #####"
          make \
            PKG_KERNEL=${{ env.REGISTRY }}/${{ github.actor }}/kernel:${{ inputs.talos_version }}-${{ inputs.device }} \
            INSTALLER_ARCH=all \
            PLATFORM=linux/amd64,linux/arm64 \
            PUSH=true \
            kernel initramfs
          echo "##### Making imager #####"
          make \
            PKG_KERNEL=${{ env.REGISTRY }}/${{ github.actor }}/kernel:${{ inputs.talos_version }}-${{ inputs.device }} \
            INSTALLER_ARCH=all \
            PLATFORM=linux/amd64,linux/arm64 \
            PUSH=true \
            imager
          popd

  ##################################################
  # Overlay
  ##################################################

  overlay:
    name: Overlay

    needs:
      - packages
      - base

    timeout-minutes: 1440
    continue-on-error: false

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        os:
          - ubuntu-latest

    steps:
      - id: checkout_repository
        name: Checkout repository
        uses: actions/checkout@v4

      # Setup Docker Buildx.
      - id: docker_buildx
        name: Setup Docker Buildx
        uses: ./.github/actions/docker-buildx
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Setup Make.
      - id: make
        name: Setup and run Make
        uses: ./.github/actions/setup_make
        with:
          repository: ${{ inputs.repo_overlay }}
          branch: ${{ inputs.branch_overlay }}
          path: ${{ github.workspace }}/_make/overlay

      # Make Overlay
      - id: make_overlay
        name: Make overlay
        env:
          TALOS_VERSION: ${{ inputs.talos_version }}
          DEVICE: ${{ inputs.device }}
          REGISTRY: ${{ env.REGISTRY }}
          USERNAME: ${{ github.actor }}
          TAG: ${{ inputs.talos_version }}-${{ inputs.device }}
          PKGS_PREFIX: ${{ env.REGISTRY }}/${{ github.actor }}
          PKGS: ${{ inputs.talos_version }}-${{ inputs.device }}
        run: |
          pushd ${{ github.workspace }}/_make/overlay
          echo "##### Making overlay #####"
          make \
            PUSH=true \
            all
          popd

  ##################################################
  # Boot
  ##################################################

  boot:
    name: Boot

    needs:
      - packages
      - base
      - overlay

    timeout-minutes: 1440
    continue-on-error: false

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        os:
          - ubuntu-latest

    steps:
      - id: checkout_repository
        name: Checkout repository
        uses: actions/checkout@v4

      # Setup Docker Buildx.
      - id: docker_buildx
        name: Setup Docker Buildx
        uses: ./.github/actions/docker-buildx
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Setup Make.
      - id: make
        name: Setup and run Make
        uses: ./.github/actions/setup_make
        with:
          repository: ${{ inputs.repo_overlay }}
          branch: ${{ inputs.branch_overlay }}
          path: ${{ github.workspace }}/_make/overlay

      # Run imager
      - id: imager
        name: Run imager
        uses: ./.github/actions/imager
        with:
          workdir: ${{ github.workspace }}/_make/overlay
          imager_image: ${{ env.REGISTRY }}/${{ github.actor }}/imager:${{ inputs.talos_version }}-${{ inputs.device }}
          overlay_name: ${{ inputs.device }}
          overlay_image: ${{ env.REGISTRY }}/${{ github.actor }}/sbc-rockchip:${{ inputs.talos_version }}-${{ inputs.device }}

      # Upload artifacts
      - id: upload_artifacts
        name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: ${{ inputs.device }}-${{ inputs.talos_version }}
          path: ${{ github.workspace }}/_make/overlay/_out/metal-arm64.raw.xz

  ##################################################
  # Release
  ##################################################

  release:
    name: Release

    if: ${{ github.event.inputs.release == 'true' }}

    needs:
      - packages
      - base
      - overlay
      - boot

    runs-on: ubuntu-latest

    steps:
      - id: download_artifacts
        name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.device }}-${{ inputs.talos_version }}
          path: ${{ github.workspace }}/_artifacts

      - id: show_artifacts
        name: Show artifacts
        run: |
          ls -lah ${{ github.workspace }}/_artifacts

      - id: calver
        name: Set Calver Version
        run: |
          if [[ "${BRANCH_NAME_CURRENT:-UNKNOWN}" == "${BRANCH_NAME_DEFAULT:-DEFAULT}" ]];
          then
            echo "Set CalVer for default branch"
            echo "package_version=$(date '+%Y-%m-%d')" >> "$GITHUB_OUTPUT"
          else
            echo "Set CalVer for non-default branch"
            echo "package_version=$(date '+%Y.%m.%d')-$(date -d "1970-01-01 UTC $(date +%T)" +%s)" >> "$GITHUB_OUTPUT"
          fi

      - id: check_tags
        name: Check git tags
        env:
          TAG: ${{ steps.calver.outputs.package_version }}
        run: |
          git fetch --tags
          if git show-ref --tags --verify --quiet "refs/tags/$TAG"
          then
            echo "The Release tag ${TAG} already exists, did you forget to bump the version?"
            exit 1
          elif [[ "${BRANCH_NAME_CURRENT:-UNKNOWN}" == "${BRANCH_NAME_DEFAULT:-DEFAULT}" ]];
          then
            echo "Default branch, creating release tag ${TAG}"
            echo "CREATE_TAG=true" >> "${GITHUB_OUTPUT}"
          else
            echo "Non-default branch, skipping release tag ${TAG}"
            echo "CREATE_TAG=false" >> "${GITHUB_OUTPUT}"
          fi

      - id: create_release
        name: Create Release
        if: ${{ steps.check_tags.outputs.CREATE_TAG == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ inputs.device }} v${{ steps.calver.outputs.package_version }}
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.calver.outputs.package_version }}
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: true
          append_body: true
          body: |
            ## Images

            Device name: ${{ inputs.device }}
            Talos version: ${{ inputs.talos_version }}

          files: ${{ github.workspace }}/_artifacts/${{ inputs.device }}-${{ inputs.talos_version }}
